<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuming Dispatch Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Set Firestore logging to Debug for troubleshooting
        setLogLevel('debug');

        // IMPORTANT GLOBAL VARIABLES PROVIDED BY THE CANVAS ENVIRONMENT
        // We use dummy values if the environment variables aren't defined (like when testing locally)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(firebaseConfigRaw);
        } catch (e) {
            console.error("Failed to parse Firebase configuration.", e);
            // This is the correct, critical check for the live environment error
            if (document.getElementById('app')) {
                document.getElementById('app').innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-gray-50">
                        <div class="p-6 bg-white rounded-xl shadow-2xl text-center max-w-sm">
                            <h2 class="text-xl font-bold text-red-600 mb-3">Initialization Error</h2>
                            <p class="text-gray-700">Firebase Configuration is missing or empty. Please check your setup.</p>
                        </div>
                    </div>
                `;
            }
            throw new Error("Firebase Configuration is missing or empty. Please check your setup.");
        }
        
        // --- CORE FIREBASE INITIALIZATION ---
        let app, db, auth;
        let userId = null;
        let userRole = null;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Firebase Initialization failed during initializeApp.", e);
            if (document.getElementById('app')) {
                document.getElementById('app').innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-gray-50">
                        <div class="p-6 bg-white rounded-xl shadow-2xl text-center max-w-sm">
                            <h2 class="text-xl font-bold text-red-600 mb-3">Initialization Failed</h2>
                            <p class="text-gray-700">Error: ${e.message}</p>
                        </div>
                    </div>
                `;
            }
            throw new Error("Firebase Initialization failed. " + e.message);
        }

        const USERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/users`;
        const ORDERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/orders`;

        // --- AUTH STATE LISTENER & INITIAL SIGN IN ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                await fetchUserRole(userId);
                renderApp();
            } else {
                // If not signed in yet, try to sign in with the custom token or anonymously
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        // Fallback to anonymous sign-in if custom token fails
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously (fallback).");
                    }
                } else {
                    // Fallback to anonymous sign-in if no token is available
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously (default).");
                }
            }
        });

        // --- AUTHENTICATION FUNCTIONS ---

        async function fetchUserRole(uid) {
            try {
                const userDocRef = doc(db, USERS_COLLECTION_PATH, uid);
                const userDocSnap = await getDoc(userDocRef);
                
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    userRole = userData.role || 'guest';
                    console.log(`User ${uid} role: ${userRole}`);
                } else {
                    // User document doesn't exist, assume a guest/unregistered role for now
                    userRole = 'guest';
                    console.log(`User document not found for ${uid}. Assuming guest role.`);
                }
            } catch (error) {
                console.error("Error fetching user role:", error);
                userRole = 'guest'; // Default to guest on error
            }
        }

        async function registerUser(uid, role) {
            const userDocRef = doc(db, USERS_COLLECTION_PATH, uid);
            await setDoc(userDocRef, { 
                role: role,
                uid: uid,
                registeredAt: serverTimestamp()
            }, { merge: true });
        }

        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            let role = 'guest';
            let loginSuccessful = false;
            let tempUserId = null;

            // Simplified Mock Authentication/Role Assignment
            if (username === 'KumingAdmin008' && password === 'KumingAdmin008') {
                role = 'admin';
                loginSuccessful = true;
                tempUserId = 'KumingAdmin008';
            } else if (username === 'KumingRider008' && password === 'KumingRider008') {
                role = 'rider';
                loginSuccessful = true;
                tempUserId = 'KumingRider008';
            } else {
                showModal('Login Failed', 'Invalid username or password.');
                return;
            }

            if (loginSuccessful) {
                // In a real app, this would be a secure authentication mechanism
                // Here, we just set the local state and register the user
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    // Sign out the anonymous user first if one exists
                    await signOut(auth);
                }
                
                // For this mock login, we will treat the username as a temporary ID.
                // In a real application, you would use Firebase Auth with email/password
                // or a custom token generated on a backend server.
                userId = tempUserId;
                userRole = role;

                // Register the mock user in the database
                await registerUser(userId, userRole);
                
                // Since we are not using standard Firebase email/password auth,
                // we manually trigger the re-render here.
                renderApp();
            }
        }
        
        function handleLogout() {
            userId = null;
            userRole = null;
            signOut(auth).then(() => {
                // After signing out, sign back in anonymously to keep Firestore access
                signInAnonymously(auth).then(() => {
                    renderApp(); // Rerender to show login screen
                }).catch(e => {
                    console.error("Error signing in anonymously after logout:", e);
                    renderApp(); // Still rerender
                });
            }).catch((error) => {
                console.error("Error during sign out:", error);
                renderApp(); // Still rerender
            });
        }

        // --- ORDER MANAGEMENT FUNCTIONS ---

        async function createNewOrder() {
            if (userRole !== 'admin') {
                showModal('Permission Denied', 'Only Admins can create new orders.');
                return;
            }
            
            const customerName = document.getElementById('new-customer-name').value;
            const address = document.getElementById('new-address').value;
            const details = document.getElementById('new-details').value;

            if (!customerName || !address || !details) {
                showModal('Error', 'Please fill in all order details.');
                return;
            }

            try {
                const newOrder = {
                    customerName,
                    address,
                    details,
                    status: 'Pending',
                    adminId: userId,
                    riderId: null,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                };

                await addDoc(collection(db, ORDERS_COLLECTION_PATH), newOrder);
                showModal('Success', 'New order created successfully!');
                
                // Clear form
                document.getElementById('new-customer-name').value = '';
                document.getElementById('new-address').value = '';
                document.getElementById('new-details').value = '';

            } catch (error) {
                console.error("Error creating new order: ", error);
                showModal('Error', `Failed to create order. ${error.message}`);
            }
        }

        async function assignRider(orderId) {
            if (userRole !== 'admin') {
                showModal('Permission Denied', 'Only Admins can assign riders.');
                return;
            }

            const riderSelect = document.getElementById(`rider-select-${orderId}`);
            const selectedRiderId = riderSelect.value;
            
            if (!selectedRiderId) {
                showModal('Error', 'Please select a rider.');
                return;
            }

            try {
                const orderDocRef = doc(db, ORDERS_COLLECTION_PATH, orderId);
                await updateDoc(orderDocRef, {
                    riderId: selectedRiderId,
                    status: 'Assigned',
                    updatedAt: serverTimestamp(),
                });
                showModal('Success', `Order ${orderId.substring(0, 4)}... assigned to rider ${selectedRiderId}.`);
            } catch (error) {
                console.error("Error assigning rider: ", error);
                showModal('Error', `Failed to assign rider. ${error.message}`);
            }
        }
        
        async function updateOrderStatus(orderId, newStatus) {
            if (userRole !== 'rider') {
                showModal('Permission Denied', 'Only Riders can update delivery status.');
                return;
            }

            try {
                const orderDocRef = doc(db, ORDERS_COLLECTION_PATH, orderId);
                await updateDoc(orderDocRef, {
                    status: newStatus,
                    updatedAt: serverTimestamp(),
                });
                showModal('Success', `Order ${orderId.substring(0, 4)}... status updated to ${newStatus}.`);
            } catch (error) {
                console.error(`Error updating status to ${newStatus}: `, error);
                showModal('Error', `Failed to update status. ${error.message}`);
            }
        }

        async function completeOrder(orderId) {
            if (userRole !== 'rider') {
                showModal('Permission Denied', 'Only Riders can complete orders.');
                return;
            }

            try {
                const orderDocRef = doc(db, ORDERS_COLLECTION_PATH, orderId);
                await updateDoc(orderDocRef, {
                    status: 'Completed',
                    updatedAt: serverTimestamp(),
                    completedAt: serverTimestamp(),
                });
                showModal('Success', `Order ${orderId.substring(0, 4)}... successfully completed!`);
            } catch (error) {
                console.error("Error completing order: ", error);
                showModal('Error', `Failed to complete order. ${error.message}`);
            }
        }
        

        // --- DATA & RENDER MANAGEMENT ---

        let allOrders = [];
        let allRiders = [];

        function startOrderListener() {
            // Base query for all orders
            let orderQuery = collection(db, ORDERS_COLLECTION_PATH);

            if (userRole === 'rider') {
                // Rider only sees orders assigned to them
                orderQuery = query(orderQuery, where('riderId', '==', userId));
            }

            // Real-time listener for orders
            onSnapshot(orderQuery, (snapshot) => {
                allOrders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                allOrders.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis()); // Sort by newest first
                renderApp();
            }, (error) => {
                console.error("Error listening to orders:", error);
                showModal('Data Error', 'Failed to load orders in real-time. Check console for details.');
            });
        }
        
        function startRiderListener() {
            // Real-time listener for riders (users with role 'rider')
            const riderQuery = query(collection(db, USERS_COLLECTION_PATH), where('role', '==', 'rider'));
            onSnapshot(riderQuery, (snapshot) => {
                allRiders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderApp();
            }, (error) => {
                console.error("Error listening to riders:", error);
                // Non-critical error, continue rendering
            });
        }
        
        let isListenersActive = false;
        function renderApp() {
            const appDiv = document.getElementById('app');
            if (!appDiv) return;

            if (!userId || !userRole || userRole === 'guest') {
                appDiv.innerHTML = renderLoginScreen();
                document.getElementById('login-button').addEventListener('click', handleLogin);
                isListenersActive = false;
                return;
            }
            
            // Activate listeners only after successful login/auth
            if (!isListenersActive) {
                startOrderListener();
                startRiderListener();
                isListenersActive = true;
            }

            let content = '';
            if (userRole === 'admin') {
                content = renderAdminDashboard();
            } else if (userRole === 'rider') {
                content = renderRiderDashboard();
            }

            appDiv.innerHTML = renderLayout(content);
            document.getElementById('logout-button').addEventListener('click', handleLogout);

            // Attach event listeners after rendering
            if (userRole === 'admin') {
                document.getElementById('create-order-button').addEventListener('click', createNewOrder);
                allOrders.forEach(order => {
                    const assignBtn = document.getElementById(`assign-btn-${order.id}`);
                    if (assignBtn) {
                        assignBtn.addEventListener('click', () => assignRider(order.id));
                    }
                });
            } else if (userRole === 'rider') {
                allOrders.forEach(order => {
                    const startBtn = document.getElementById(`start-btn-${order.id}`);
                    const deliveredBtn = document.getElementById(`delivered-btn-${order.id}`);
                    const completeBtn = document.getElementById(`complete-btn-${order.id}`);

                    if (startBtn) startBtn.addEventListener('click', () => updateOrderStatus(order.id, 'In Progress'));
                    if (deliveredBtn) deliveredBtn.addEventListener('click', () => updateOrderStatus(order.id, 'Delivered'));
                    if (completeBtn) completeBtn.addEventListener('click', () => completeOrder(order.id));
                });
            }
        }
        

        // --- UI COMPONENTS ---

        function renderLoginScreen() {
            return `
                <div class="flex items-center justify-center min-h-screen bg-gray-100">
                    <div class="p-8 bg-white rounded-xl shadow-2xl w-full max-w-sm">
                        <h1 class="text-3xl font-extrabold text-blue-600 mb-2 text-center">Dispatch Login</h1>
                        <p class="text-sm text-gray-500 mb-6 text-center">
                            Admin: KumingAdmin008 / KumingAdmin008<br>
                            Rider: KumingRider008 / KumingRider008
                        </p>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                                <input type="text" id="username" value="" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="password" value="" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button id="login-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                Login
                            </button>
                        </div>
                        <div id="error-message" class="mt-4 text-center text-red-500 text-sm hidden"></div>
                    </div>
                </div>
            `;
        }

        function renderLayout(content) {
            return `
                <div class="min-h-screen bg-gray-50">
                    <header class="bg-blue-600 shadow">
                        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-white">Kuming Dispatch: ${userRole.toUpperCase()}</h1>
                            <div class="flex items-center space-x-4">
                                <span class="text-white text-sm">User ID: ${userId}</span>
                                <button id="logout-button" class="px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-600 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white transition duration-150 ease-in-out">
                                    Logout
                                </button>
                            </div>
                        </div>
                    </header>
                    <main>
                        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                            ${content}
                        </div>
                    </main>
                    ${renderModal()}
                </div>
            `;
        }
        
        function renderAdminDashboard() {
            // Sort orders: Pending first, then Assigned, then In Progress, then Delivered/Completed
            const sortedOrders = allOrders.sort((a, b) => {
                const statusOrder = { 'Pending': 1, 'Assigned': 2, 'In Progress': 3, 'Delivered': 4, 'Completed': 5 };
                return statusOrder[a.status] - statusOrder[b.status];
            });

            return `
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Create New Order</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="new-customer-name" placeholder="Customer Name" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="new-address" placeholder="Delivery Address" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="new-details" placeholder="Order Details (e.g., 2 Pizzas, 1 Drink)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button id="create-order-button" class="mt-4 w-full py-2 px-4 rounded-md text-white bg-green-500 hover:bg-green-600 transition duration-150 ease-in-out">
                            Create Order
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">All Orders (${allOrders.length})</h2>
                        <div class="space-y-4">
                            ${sortedOrders.length > 0 ? sortedOrders.map(renderAdminOrderCard).join('') : '<p class="text-gray-500">No orders found.</p>'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderAdminOrderCard(order) {
            const statusColor = {
                'Pending': 'bg-yellow-100 text-yellow-800',
                'Assigned': 'bg-blue-100 text-blue-800',
                'In Progress': 'bg-indigo-100 text-indigo-800',
                'Delivered': 'bg-green-100 text-green-800',
                'Completed': 'bg-green-200 text-green-800 font-bold',
            }[order.status] || 'bg-gray-100 text-gray-800';

            const formattedTime = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleString() : 'N/A';
            const riderName = order.riderId ? allRiders.find(r => r.uid === order.riderId)?.uid || order.riderId : 'Unassigned';
            
            return `
                <div class="p-4 border rounded-lg shadow-sm bg-white hover:shadow-md transition duration-150 ease-in-out">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-gray-900">Order #${order.id.substring(0, 8)}</h3>
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColor}">${order.status}</span>
                    </div>
                    
                    <p class="text-sm text-gray-600"><strong>Customer:</strong> ${order.customerName}</p>
                    <p class="text-sm text-gray-600"><strong>Details:</strong> ${order.details}</p>
                    <p class="text-sm text-gray-600"><strong>Address:</strong> ${order.address}</p>
                    <p class="text-xs text-gray-400 mt-1">Created: ${formattedTime}</p>
                    
                    <div class="mt-3 pt-3 border-t border-dashed">
                        <p class="text-sm font-medium text-gray-700 mb-2">Rider: ${riderName}</p>
                        
                        ${order.status === 'Pending' ? `
                            <div class="flex space-x-2 items-center">
                                <select id="rider-select-${order.id}" class="flex-grow p-2 border border-gray-300 rounded-md text-sm">
                                    <option value="">Select Rider</option>
                                    ${allRiders.map(rider => `<option value="${rider.uid}">${rider.uid}</option>`).join('')}
                                </select>
                                <button id="assign-btn-${order.id}" class="px-3 py-2 text-sm font-medium rounded-md text-white bg-indigo-500 hover:bg-indigo-600 transition duration-150 ease-in-out whitespace-nowrap">
                                    Assign
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderRiderDashboard() {
             // Sort orders: In Progress/Assigned first, then Delivered, then Completed
            const sortedOrders = allOrders.sort((a, b) => {
                const statusOrder = { 'Assigned': 1, 'In Progress': 2, 'Delivered': 3, 'Completed': 4 };
                return statusOrder[a.status] - statusOrder[b.status];
            });

            const currentOrders = sortedOrders.filter(o => o.status !== 'Completed');
            const completedOrders = sortedOrders.filter(o => o.status === 'Completed');
            
            return `
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Your Current Deliveries (${currentOrders.length})</h2>
                        <div class="space-y-4">
                            ${currentOrders.length > 0 ? currentOrders.map(renderRiderOrderCard).join('') : '<p class="text-gray-500">No active deliveries assigned.</p>'}
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Completed Deliveries (${completedOrders.length})</h2>
                        <div class="space-y-4 opacity-70">
                            ${completedOrders.length > 0 ? completedOrders.map(renderRiderOrderCard).join('') : '<p class="text-gray-500">No completed deliveries yet.</p>'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderRiderOrderCard(order) {
            const statusColor = {
                'Pending': 'bg-yellow-100 text-yellow-800',
                'Assigned': 'bg-blue-100 text-blue-800',
                'In Progress': 'bg-indigo-100 text-indigo-800',
                'Delivered': 'bg-green-100 text-green-800',
                'Completed': 'bg-green-200 text-green-800 font-bold',
            }[order.status] || 'bg-gray-100 text-gray-800';

            const formattedTime = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleTimeString() : 'N/A';
            
            return `
                <div class="p-4 border rounded-lg shadow-sm bg-white hover:shadow-md transition duration-150 ease-in-out">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-gray-900">Order #${order.id.substring(0, 8)}</h3>
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColor}">${order.status}</span>
                    </div>
                    
                    <p class="text-sm text-gray-600"><strong>Customer:</strong> ${order.customerName}</p>
                    <p class="text-sm text-gray-600"><strong>Details:</strong> ${order.details}</p>
                    <p class="text-sm font-bold text-gray-700"><strong>Address:</strong> ${order.address}</p>
                    <p class="text-xs text-gray-400 mt-1">Assigned at: ${formattedTime}</p>
                    
                    <div class="mt-3 pt-3 border-t border-dashed">
                        ${order.status === 'Assigned' ? `
                            <button id="start-btn-${order.id}" class="w-full py-2 px-4 rounded-md text-white bg-blue-500 hover:bg-blue-600 transition duration-150 ease-in-out">
                                Start Delivery
                            </button>
                        ` : ''}
                        
                        ${order.status === 'In Progress' ? `
                            <button id="delivered-btn-${order.id}" class="w-full py-2 px-4 rounded-md text-white bg-yellow-500 hover:bg-yellow-600 transition duration-150 ease-in-out">
                                Arrived/Handed Over
                            </button>
                        ` : ''}
                        
                        ${order.status === 'Delivered' ? `
                            <button id="complete-btn-${order.id}" class="w-full py-2 px-4 rounded-md text-white bg-green-500 hover:bg-green-600 transition duration-150 ease-in-out">
                                Complete Order
                            </button>
                        ` : ''}
                        
                        ${order.status === 'Completed' ? `
                            <p class="text-center text-sm font-semibold text-green-600">Order is completed.</p>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // --- MODAL / MESSAGE BOX ---
        let modalState = {
            title: '',
            message: '',
            isVisible: false
        };

        function showModal(title, message) {
            modalState = { title, message, isVisible: true };
            const modal = document.getElementById('global-modal');
            if (modal) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-message').innerText = message;
                modal.classList.remove('hidden');
            }
        }

        function closeModal() {
            modalState.isVisible = false;
            const modal = document.getElementById('global-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function renderModal() {
            // Note: The modal is rendered once in the layout and controlled via CSS classes
            return `
                <div id="global-modal" class="fixed inset-0 z-50 overflow-y-auto ${modalState.isVisible ? '' : 'hidden'}" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <!-- Background overlay -->
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
                        
                        <!-- Modal content -->
                        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <div class="sm:flex sm:items-start">
                                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                        <svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                                        <div class="mt-2">
                                            <p class="text-sm text-gray-500" id="modal-message"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="button" onclick="closeModal()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- INITIAL KICKOFF ---
        // Add listeners to ensure the modal functions before the main app starts
        window.closeModal = closeModal; // Expose to global scope for inline onclick

        document.addEventListener('DOMContentLoaded', () => {
            renderApp(); // Initial render will handle login or dashboard based on auth state
        });
        
    </script>
</head>
<body class="font-sans antialiased">
    <div id="app">
        <!-- Content will be injected here by the renderApp function -->
    </div>
</body>
</html>
